<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ftblzone - CanlÄ± MaÃ§ Takip ve Linkler</title>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-RY0R6H71QX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-RY0R6H71QX');
</script>

<style>
/* GENEL STÄ°LLER */
body{font-family:Arial,sans-serif;text-align:center;margin:0;padding:10px;transition:background 0.5s,color 0.5s; background-color: #fff; color: #000;}
h1,h2,h3,h4{margin:10px 0;}
button{margin:5px;padding:10px 20px;border:none;cursor:pointer;border-radius:6px;font-size:16px; background-color: #333; color: white;}
input,select,textarea{margin:6px;padding:8px;border-radius:6px;font-size:16px;width:90%;max-width:300px; border: 1px solid #ccc;}
textarea{resize:none;}

/* YERLEÅÄ°M VE GÃ–RÃœNÃœM */
.adminPanel{display:none;margin-top:20px;border:1px solid #ccc;padding:15px;text-align:left; max-width: 600px; margin: 20px auto;}
.timers,.links,.themeChanger,.adminLogin,.predictionGame,.quizContainer, .pollContainer, .feedbackContainer{margin-top:30px; padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 20px;}
a{display:block;margin:5px 0;color:inherit;text-decoration:none; font-weight: bold;}

/* GÃœNCELLEME: BASÄ°T LÄ°STE VE BOÅLUK STÄ°LÄ° */
.links div[id$="Links"], 
.links div[id$="Summary"] {
    margin-bottom: 25px;
    border: 1px dashed #ddd;
    padding: 10px;
}
.linkItem{
    display: block; 
    margin: 10px auto; 
    max-width: 500px;
    padding: 5px 0;
    border-bottom: 1px dotted #ddd;
    text-align: left;
    background: none; 
    color: inherit;
}
.linkItem a { 
    display: inline; 
    font-weight: normal;
}
.linkItem span{
    display: inline;
    font-size: 11px;
    color: #777;
    margin-left: 10px;
}
.timerItem{border:1px solid #ddd;border-radius:6px;padding:10px;margin:10px auto;max-width:400px;text-align:center; background-color: #f0f0f0; color: #333;}
.timerItem p{margin: 0;}
#allNextMatchesContainer { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;}

/* TAHMÄ°N OYUNU STÄ°LLERÄ° */
.predictionGame { background-color: #e9f5ff; border: 2px solid #007bff; border-radius: 10px; padding: 20px;}
.predictionForm, .predictionResults { max-width: 500px; margin: 15px auto; padding: 15px; border: 1px solid #007bff; border-radius: 8px; text-align: left; background-color: white; }
.predictionResults { border-color: #28a745; text-align: center; background-color: #e8fadf;}
.tahminBaslik { text-align: center; color: #007bff; font-weight: bold;}
.kazananlarListesi { margin-top: 10px; text-align: left; }
.prediction-selection { display: inline-block; margin: 5px; }
#weeklyWinner { background-color: #ffc107; color: #333; padding: 10px; border-radius: 6px; margin-bottom: 20px; font-weight: bold; }

/* DUYURU, QUIZ VE ANKET STÄ°LLERÄ° */
#announcementBar { background-color: #dc3545; color: white; padding: 10px; margin-bottom: 20px; font-weight: bold; height: 30px; overflow: hidden; position: relative; }
.announcement-item { position: absolute; width: 100%; text-align: center; top: 10px; opacity: 0; transition: opacity 0.5s; }
.announcement-item.active { opacity: 1; }

.quizContainer { border: 2px solid #5aa1e3; border-radius: 10px; padding: 20px; background-color: #f5faff; }
.quizQuestion { font-weight: bold; margin-bottom: 15px; color: #0033cc; }
.quizOption { display: block; margin: 8px 0; padding: 5px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; text-align: left;}
.quizOption:hover { background-color: #e0f7ff; }
.quizResults { margin-top: 15px; padding: 10px; border-top: 1px solid #ccc; text-align: left;}

.option-control { display: flex; align-items: center; margin-bottom: 5px; }
.option-control input { flex: 1; margin-right: 10px; }
.remove-option { background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; }

/* Ä°yileÅŸtirilmiÅŸ Quiz ve Anket Stilleri (Anket Link iÃ§in gÃ¼ncellendi) */
.quiz-countdown, .poll-countdown { 
    background-color: #ffc107; 
    color: #333; 
    padding: 8px; 
    border-radius: 6px; 
    margin-bottom: 15px; 
    font-weight: bold;
    text-align: center;
}
.quiz-expired, .poll-expired { 
    background-color: #dc3545; 
    color: white; 
    padding: 8px; 
    border-radius: 6px; 
    margin-bottom: 15px; 
    font-weight: bold;
    text-align: center;
}
.quiz-active, .poll-active { 
    background-color: #28a745; 
    color: white; 
    padding: 8px; 
    border-radius: 6px; 
    margin-bottom: 15px; 
    font-weight: bold;
    text-align: center;
}
.user-vote-indicator {
    background-color: #007bff;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.8em;
    margin-left: 5px;
}

/* Geri Bildirim Stilleri */
.feedbackContainer { 
    margin-top: 30px; 
    padding: 20px; 
    border: 2px solid #5cb85c; 
    border-radius: 10px; 
    background-color: #f9fff9; 
    max-width: 500px;
    margin: 30px auto;
}
.feedbackContainer input, .feedbackContainer textarea {
    width: 90%;
    max-width: none;
    display: block;
    margin: 10px auto;
}

/* Modal (AÃ§Ä±lÄ±r Pencere) Stilleri */
.modal {
    display: none; /* VarsayÄ±lan olarak kapalÄ± */
    position: fixed; 
    z-index: 10; 
    left: 0;
    top: 0;
    width: 100%; 
    height: 100%; 
    overflow: auto; 
    background-color: rgba(0,0,0,0.4); 
}
.modal-content {
    background-color: #fefefe;
    margin: 10% auto; 
    padding: 20px;
    border: 1px solid #888;
    width: 80%; 
    max-width: 600px;
    border-radius: 8px;
    text-align: left;
    color: #000;
}
.close-btn {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}
.close-btn:hover, .close-btn:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
}
.version-item {
    border-bottom: 1px dashed #ccc;
    padding: 10px 0;
    margin-bottom: 10px;
}
.version-item h5 {
    color: #dc3545;
    margin: 0;
    font-size: 1.1em;
}
.version-item p {
    margin: 5px 0 0 0;
    white-space: pre-wrap; /* NotlarÄ±n yeni satÄ±rlarÄ±nÄ± korur */
}

/* TEMA STÄ°LLERÄ° */
.yellow-red-theme{background:#ffcc00;color:#b30000;}
.yellow-blue-theme{background:#ffcc00;color:#0033cc;}
.black-theme{background:#000;color:#fff;}
.black-white-theme{background:#111;color:#eee;}
.claret-blue-theme{background:#7b2f3a;color:#5aa1e3;}
</style>
</head>
<body onload="checkAdminStatus(); requestNotificationPermission(); showActivePredictionGame(); loadAnnouncements(); loadWeeklyWinner(); loadActiveQuiz(); loadActivePoll(); updateDailyLinksHeader();">
<div id="announcementBar"></div>

<h1>ftblzone - MaÃ§ Linkleri ve Bilgileri</h1>

<div id="weeklyWinner" style="display: none;"></div>

<div class="timers">
    <h3>â° MaÃ§ Geri SayÄ±mlarÄ±</h3>
    <div id="allNextMatchesContainer"></div>
</div>

<div class="quizContainer">
    <h2>ğŸ§  Bilgi YarÄ±ÅŸmasÄ± (Quiz)</h2>
    <div id="quizGameContainer">
        <p style="font-style: italic; color: #777;">Åu anda aktif bir bilgi yarÄ±ÅŸmasÄ± bulunmamaktadÄ±r.</p>
    </div>
</div>

<div class="pollContainer">
    <h2>ğŸ”— SÃ¼reli Duyuru/Link</h2>
    <div id="pollGameContainer">
        <p style="font-style: italic; color: #777;">Åu anda aktif bir anket bulunmamaktadÄ±r.</p>
    </div>
</div>

<div class="predictionGame">
    <h2>ğŸ† MaÃ§ Tahmin Oyunu (5 FarklÄ± Puanlama)</h2>
    <div id="predictionGameContainer">
        <p style="font-style: italic; color: #777;">Åu anda aktif bir tahmin oyunu bulunmamaktadÄ±r.</p>
    </div>
</div>

<div class="feedbackContainer">
    <h2>ğŸ“§ Ã–neri, Åikayet ve Ä°letiÅŸim</h2>
    <input type="text" id="feedbackName" placeholder="AdÄ±nÄ±z">
    <input type="email" id="feedbackEmail" placeholder="E-posta Adresiniz (Ä°steÄŸe BaÄŸlÄ±)">
    <textarea id="feedbackMessage" placeholder="MesajÄ±nÄ±z (Ã–neri, Åikayet, Hata Bildirimi)" rows="4"></textarea>
    <button onclick="submitFeedback()" style="background-color: #5cb85c;">Geri Bildirim GÃ¶nder</button>
</div>

<div class="themeChanger">
<h3>Tema SeÃ§in</h3>
<select id="themeSelect" onchange="changeTheme()">
<option value="white">Beyaz (VarsayÄ±lan)</option>
<option value="black">Siyah</option>
<option value="yellow-red">SarÄ±-KÄ±rmÄ±zÄ±</option>
<option value="yellow-blue">SarÄ±-Lacivert</option>
<option value="black-white">Siyah-Beyaz</option>
<option value="claret-blue">Bordo-Mavi</option>
</select>
<button onclick="openVersionModal()" style="background-color: #555; margin-top: 15px;">SÃ¼rÃ¼m ve GÃ¼ncelleme NotlarÄ±</button>
</div>

<div style="max-width: 500px; margin: 20px auto;">
    <input type="text" id="linkSearch" onkeyup="searchLinks()" placeholder="Linklerde Arama Yap (Ã–rn: FB GS, Bein)">
</div>

<div class="links">
<h2 id="dailyLinksHeader">âš½ GÃ¼nlÃ¼k MaÃ§ Linkleri</h2>
<div id="dailyLinks"></div>

<h2>ğŸ‡¹ğŸ‡· TÃ¼rkiye 4 BÃ¼yÃ¼kler Linkleri</h2>
<div id="big4Links"></div>

<h2>ğŸ¥… Gol VideolarÄ±</h2>
<div id="goalLinks"></div>

<h2>ğŸ¬ MaÃ§ Ã–zetleri</h2>
<h4>KÄ±sa Ã–zet</h4>
<div id="shortSummary"></div>
<h4>Uzun Ã–zet</h4>
<div id="longSummary"></div>
</div>

<div class="adminLogin" id="adminLogin">
<h2>ğŸ”‘ YÃ¶netici GiriÅŸi</h2>
<input type="password" id="adminPass" placeholder="Åifre">
<button onclick="checkAdmin()">GiriÅŸ</button>
</div>

<div class="adminPanel" id="adminPanel">
<h3>Admin Paneli - Ä°Ã§erik YÃ¶netimi</h3>
<button onclick="logoutAdmin()" style="background-color: #555;">Ã‡Ä±kÄ±ÅŸ Yap</button>
<hr>

<div id="announcementAdminControls">
    <h4>ğŸ“¢ Ã‡oklu Duyuru YÃ¶netimi</h4>
    <input id="newAnnouncementText" placeholder="Yeni Duyuru Metni">
    <button onclick="addAnnouncement()">Duyuru Ekle</button>
    <button onclick="clearCollection('announcements', 'TÃ¼m Duyurular')" style="background-color: #d9534f;">TÃ¼m DuyurularÄ± Sil</button>
    <div id="currentAnnouncements" style="margin-top: 10px;"></div>
    <hr>
</div>

<div id="quizAdminControls">
    <h4>ğŸ§  Quiz (Bilgi YarÄ±ÅŸmasÄ±) YÃ¶netimi</h4>
    <input id="quizQuestion" placeholder="Soru Metni">
    <div id="quizOptionsContainer">
        <div class="option-control">
            <input id="quizOption1" placeholder="SeÃ§enek 1">
        </div>
        <div class="option-control">
            <input id="quizOption2" placeholder="SeÃ§enek 2">
        </div>
    </div>
    <button onclick="addQuizOption()" style="background-color: #28a745;">+ SeÃ§enek Ekle</button>
    <select id="quizCorrectOption">
        <option value="1">DoÄŸru Cevap: SeÃ§enek 1</option>
        <option value="2">DoÄŸru Cevap: SeÃ§enek 2</option>
    </select>
    
    <div style="margin-top: 10px;">
        <label><input type="checkbox" id="quizHasDeadline" onchange="toggleQuizDeadline()"> SÃ¼re sÄ±nÄ±rÄ± ekle</label>
        <div id="quizDeadlineContainer" style="display: none; margin-top: 10px;">
            <label>BaÅŸlangÄ±Ã§:</label>
            <input type="datetime-local" id="quizStartTime">
            <label>BitiÅŸ:</label>
            <input type="datetime-local" id="quizDeadline">
        </div>
    </div>
    
    <button onclick="createQuiz()">Quizi BaÅŸlat/GÃ¼ncelle</button>
    <button onclick="deleteQuiz()" style="background-color: #888;">Quizi Kapat</button>
    <button onclick="clearCollection('quizAnswers', 'TÃ¼m Quiz CevaplarÄ±')" style="background-color: #d9534f; margin-top: 5px;">CevaplarÄ± Temizle</button>
    <hr>
</div>

<div id="pollAdminControls">
    <h4>ğŸ”— Anket/Duyuru Linki YÃ¶netimi (SÃ¼reli)</h4>
    <input id="pollLink" placeholder="Link (URL)">
    <input id="pollDesc" placeholder="AÃ§Ä±klama (Ã–rn: HaftanÄ±n MaÃ§Ä± Anketi)">
    
    <div style="margin-top: 10px;">
        <label><input type="checkbox" id="pollHasDeadline" onchange="togglePollDeadline()"> SÃ¼re sÄ±nÄ±rÄ± ekle</label>
        <div id="pollDeadlineContainer" style="display: none; margin-top: 10px;">
            <label>BitiÅŸ:</label>
            <input type="datetime-local" id="pollDeadline">
        </div>
    </div>
    
    <button onclick="createPoll()">Linki BaÅŸlat/GÃ¼ncelle</button>
    <button onclick="deletePoll()" style="background-color: #888;">Linki Kapat</button>
    <hr>
</div>
<div id="predictionAdminControls">
    <h4>ğŸ† Tahmin Oyunu YÃ¶netimi</h4>
    <input id="tahminMatchName" placeholder="MaÃ§ AdÄ± (Ã–rn: FB - GS)">
    <input id="tahminTeamA" placeholder="TakÄ±m A AdÄ± (Ã–rn: FenerbahÃ§e)">
    <input id="tahminTeamB" placeholder="TakÄ±m B AdÄ± (Ã–rn: Galatasaray)">
    <input type="datetime-local" id="tahminDeadline">
    <button onclick="createPredictionGame()">Oyunu BaÅŸlat / GÃ¼ncelle</button>
    <button onclick="deletePredictionGame()" style="background-color: #888;">Oyunu Kapat</button>
    
    <hr style="margin-top: 15px;">
    <h5>MaÃ§ Sonucu ve KazananlarÄ± Gir</h5>
    <input type="number" id="resultScoreA" placeholder="A Skoru">
    <input type="number" id="resultScoreB" placeholder="B Skoru">
    <select id="resultMatchResult">
        <option value="none">MaÃ§ Sonucu (1-X-2)</option>
        <option value="1">1 (A KazanÄ±r)</option>
        <option value="X">X (Berabere)</option>
        <option value="2">2 (B KazanÄ±r)</option>
    </select>
    <select id="resultGoalCount">
        <option value="none">Toplam Gol SayÄ±sÄ±</option>
        <option value="ust">2.5 ÃœstÃ¼</option>
        <option value="alt">2.5 AltÄ±</option>
    </select>
    <select id="resultCardCount">
        <option value="none">SarÄ± Kart SayÄ±sÄ±</option>
        <option value="ust">4.5 ÃœstÃ¼</option>
        <option value="alt">4.5 AltÄ±</option>
    </select>
    <button onclick="publishPredictionResults()" style="margin-top: 10px; background-color: #28a745;">SonuÃ§larÄ± AÃ§Ä±kla</button>
</div>
<hr>

<div id="versionAdminControls">
    <h4>ğŸ“œ SÃ¼rÃ¼m ve GÃ¼ncelleme NotlarÄ±</h4>
    <input id="versionNo" placeholder="SÃ¼rÃ¼m No (Ã–rn: V.1.7)">
    <textarea id="updateNotes" placeholder="GÃ¼ncelleme NotlarÄ± (SÃ¼rÃ¼m AÃ§Ä±klamasÄ±)"></textarea>
    <button onclick="setVersionInfo()">SÃ¼rÃ¼m Bilgisini Kaydet</button>
</div>
<hr>
<div id="nextMatchAdminControls">
    <h4>Yeni Geri SayÄ±m Ekle</h4>
    <input type="datetime-local" id="newMatchDate">
    <input type="text" id="newMatchText" placeholder="MaÃ§ AÃ§Ä±klamasÄ± (admin)">
    <button onclick="addNextMatch()">Geri SayÄ±mÄ± Ekle</button>
    <hr>
</div>

<h4>âš½ GÃ¼nlÃ¼k MaÃ§ Linki Ekle (Tarih/Saat ile SÃ¼re SÄ±nÄ±rÄ±)</h4>
<input id="dailyLink" placeholder="Link (URL)">
<input id="dailyDesc" placeholder="AÃ§Ä±klama (Ã–rn: FB - GS CanlÄ±)">
<div style="margin-top: 10px;">
    <label><input type="checkbox" id="dailyHasDeadline" onchange="toggleDailyDeadline()"> SÃ¼re sÄ±nÄ±rÄ± ekle</label>
    <div id="dailyDeadlineContainer" style="display: none; margin-top: 10px;">
        <input type="datetime-local" id="dailyDeadline">
    </div>
</div>
<button onclick="addDailyLink()">Ekle</button>
<button onclick="clearCollection('dailyLinks', 'GÃ¼nlÃ¼k MaÃ§ Linkleri')" style="background-color: #d9534f;">TÃ¼mÃ¼nÃ¼ Temizle</button>
<hr>

<h4>ğŸ‡¹ğŸ‡· 4 BÃ¼yÃ¼kler Linki Ekle (Tarih/Saat ile SÃ¼re SÄ±nÄ±rÄ±)</h4>
<input id="big4Link" placeholder="Link (URL)">
<input id="big4Desc" placeholder="AÃ§Ä±klama">
<div style="margin-top: 10px;">
    <label><input type="checkbox" id="big4HasDeadline" onchange="toggleBig4Deadline()"> SÃ¼re sÄ±nÄ±rÄ± ekle</label>
    <div id="big4DeadlineContainer" style="display: none; margin-top: 10px;">
        <input type="datetime-local" id="big4Deadline">
    </div>
</div>
<button onclick="addBig4Link()">Ekle</button>
<button onclick="clearCollection('big4Links', '4 BÃ¼yÃ¼kler Linkleri')" style="background-color: #d9534f;">TÃ¼mÃ¼nÃ¼ Temizle</button>
<hr>

<h4>ğŸ¥… Gol Videosu Ekle (Tarih/Saat ile SÃ¼re SÄ±nÄ±rÄ±)</h4>
<input id="goalLink" placeholder="Link (URL)">
<input id="goalDesc" placeholder="AÃ§Ä±klama (Ã–rn: Ronaldo GolÃ¼)">
<div style="margin-top: 10px;">
    <label><input type="checkbox" id="goalHasDeadline" onchange="toggleGoalDeadline()"> SÃ¼re sÄ±nÄ±rÄ± ekle</label>
    <div id="goalDeadlineContainer" style="display: none; margin-top: 10px;">
        <input type="datetime-local" id="goalDeadline">
    </div>
</div>
<button onclick="addGoalLink()">Ekle</button>
<button onclick="clearCollection('goalLinks', 'Gol VideolarÄ±')" style="background-color: #d9534f;">TÃ¼mÃ¼nÃ¼ Temizle</button>
<hr>

<h4>ğŸ¬ MaÃ§ Ã–zeti Ekle (Tarih/Saat ile SÃ¼re SÄ±nÄ±rÄ±)</h4>
<div style="margin-top: 10px;">
    <label><input type="checkbox" id="summaryHasDeadline" onchange="toggleSummaryDeadline()"> SÃ¼re sÄ±nÄ±rÄ± ekle</label>
    <div id="summaryDeadlineContainer" style="display: none; margin-top: 10px;">
        <input type="datetime-local" id="summaryDeadline">
    </div>
</div>
<input id="shortLink" placeholder="KÄ±sa Ã–zet Linki">
<input id="shortDesc" placeholder="KÄ±sa Ã–zet AÃ§Ä±klama">
<button onclick="addShortSummary()">KÄ±sa Ekle</button>
<button onclick="clearCollection('shortSummary', 'KÄ±sa Ã–zetler')" style="background-color: #d9534f; margin-top: 5px;">KÄ±sa Temizle</button>
<br>
<input id="longLink" placeholder="Uzun Ã–zet Linki">
<input id="longDesc" placeholder="Uzun Ã–zet AÃ§Ä±klama">
<button onclick="addLongSummary()">Uzun Ekle</button>
<button onclick="clearCollection('longSummary', 'Uzun Ã–zetler')" style="background-color: #d9534f; margin-top: 5px;">Uzun Temizle</button>
</div>

<div id="versionModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeVersionModal()">&times;</span>
    <h2>ğŸ“œ SÃ¼rÃ¼m ve GÃ¼ncelleme GeÃ§miÅŸi</h2>
    <div id="versionHistoryList">YÃ¼kleniyor...</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
// ===============================================
// ğŸ”¥ğŸ”¥ğŸ”¥ FIREBASE BÄ°LGÄ°LERÄ° ğŸ”¥ğŸ”¥ğŸ”¥
// BU BÄ°LGÄ°LERÄ° KENDÄ° FIREBASE PROJENÄ°ZLE DEÄÄ°ÅTÄ°RMELÄ°SÄ°NÄ°Z!
// ===============================================
const firebaseConfig = {
  apiKey: "AIzaSyDP46kVlCHwKdWPjnXL86Zl0DncQfqFc00",
  authDomain: "ftblzone-93b54.firebaseapp.com",
  projectId: "ftblzone-93b54",
  storageBucket: "ftblzone-93b54.appspot.com", 
  messagingSenderId: "1006008662097",
  appId: "1:1006008662097:web:8b874f6b39fa2c05896070",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const ADMIN_PASSWORD = "ftblscoreadmin2025"; 
const ADMIN_TOKEN_KEY = "ftblzone_admin_logged_in";

// ===============================================

let matchIntervals = {};
let allLinksData = []; 
let currentPredictionGame = null;
let currentAnnouncementIndex = 0;
let announcementData = [];
let quizInterval = null;
let pollInterval = null;
let currentQuiz = null;

// === TEMA VE ADMÄ°N FONKSÄ°YONLARI ===

function changeTheme(){ 
    const t=document.getElementById("themeSelect").value; 
    const body=document.body;
    body.classList.remove("yellow-red-theme", "yellow-blue-theme", "black-theme", "black-white-theme", "claret-blue-theme");
    switch(t){
        case "white": body.style.background="#fff"; body.style.color="#000"; break;
        case "black": body.classList.add("black-theme"); body.style.background="#000"; body.style.color="#fff"; break;
        case "yellow-red": body.classList.add("yellow-red-theme"); body.style.background="#ffcc00"; body.style.color="#b30000"; break;
        case "yellow-blue": body.classList.add("yellow-blue-theme"); body.style.background="#ffcc00"; body.style.color="#0033cc"; break;
        case "black-white": body.classList.add("black-white-theme"); body.style.background="#111"; body.style.color="#eee"; break;
        case "claret-blue": body.classList.add("claret-blue-theme"); body.style.background="#7b2f3a"; body.style.color="#5aa1e3"; break;
    }
}

function checkAdminStatus() {
    if (localStorage.getItem(ADMIN_TOKEN_KEY) === 'true') {
        openAdminPanel();
    }
}

function openAdminPanel() {
    document.getElementById("adminPanel").style.display="block";
    document.getElementById("adminLogin").style.display="none";
    showAllLinks(); 
    showNextMatches();
    loadPredictionGameSettings(); 
    loadAdminAnnouncements(); 
}

function checkAdmin(){ 
    const pass=document.getElementById("adminPass").value;
    if(pass===ADMIN_PASSWORD){
        localStorage.setItem(ADMIN_TOKEN_KEY, 'true');
        openAdminPanel();
        alert("Admin giriÅŸi baÅŸarÄ±lÄ± âœ…");
    } else {
        alert("YanlÄ±ÅŸ ÅŸifre âŒ");
    }
}

function logoutAdmin() {
    localStorage.removeItem(ADMIN_TOKEN_KEY);
    document.getElementById("adminPanel").style.display="none";
    document.getElementById("adminLogin").style.display="block";
    alert("Admin Ã§Ä±kÄ±ÅŸÄ± yapÄ±ldÄ±.");
    showAllLinks();
    showNextMatches();
}

// === SÃœRE AYARLARI FONKSÄ°YONLARI ===

function toggleQuizDeadline() {
    const container = document.getElementById("quizDeadlineContainer");
    container.style.display = document.getElementById("quizHasDeadline").checked ? "block" : "none";
}

function togglePollDeadline() {
    const container = document.getElementById("pollDeadlineContainer");
    container.style.display = document.getElementById("pollHasDeadline").checked ? "block" : "none";
}

function toggleDailyDeadline() {
    const container = document.getElementById("dailyDeadlineContainer");
    container.style.display = document.getElementById("dailyHasDeadline").checked ? "block" : "none";
}

function toggleBig4Deadline() {
    const container = document.getElementById("big4DeadlineContainer");
    container.style.display = document.getElementById("big4HasDeadline").checked ? "block" : "none";
}

function toggleGoalDeadline() {
    const container = document.getElementById("goalDeadlineContainer");
    container.style.display = document.getElementById("goalHasDeadline").checked ? "block" : "none";
}

function toggleSummaryDeadline() {
    const container = document.getElementById("summaryDeadlineContainer");
    container.style.display = document.getElementById("summaryHasDeadline").checked ? "block" : "none";
}

// === LÄ°NK VE Ä°Ã‡ERÄ°K YÃ–NETÄ°MÄ° ===

function addLink(col, linkId, descId, deadlineCheckboxId = null, deadlineInputId = null){ 
    if(localStorage.getItem(ADMIN_TOKEN_KEY) !== 'true') return alert("Sadece admin ekleyebilir!");
    const link=document.getElementById(linkId).value; 
    const desc=document.getElementById(descId).value;
    
    let expiryTime = 0;
    
    if (deadlineCheckboxId && deadlineInputId) {
        const hasDeadline = document.getElementById(deadlineCheckboxId).checked;
        if (hasDeadline) {
            const deadlineValue = document.getElementById(deadlineInputId).value;
            if (!deadlineValue) {
                return alert("SÃ¼re sÄ±nÄ±rÄ± seÃ§tiniz ama tarih/saat belirtmediniz!");
            }
            expiryTime = new Date(deadlineValue).getTime();
        }
    }

    if (!link || !desc) { return alert("Link ve aÃ§Ä±klama boÅŸ bÄ±rakÄ±lamaz."); }
    
    db.collection(col).add({
        link: link,
        desc: desc,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        expiryTime: expiryTime
    }).then(() => {
        alert("Link baÅŸarÄ±yla eklendi âœ…");
        document.getElementById(linkId).value = ''; 
        document.getElementById(descId).value = '';
        if (deadlineCheckboxId) {
            document.getElementById(deadlineCheckboxId).checked = false;
            if (deadlineInputId) {
                document.getElementById(deadlineInputId).value = '';
                document.getElementById(deadlineInputId + "Container").style.display = "none";
            }
        }
    }).catch(error => {
        console.error("Link ekleme hatasÄ±: ", error);
        alert("Link eklenirken bir hata oluÅŸtu. Firebase kurallarÄ±nÄ±zÄ± kontrol edin.");
    });
}

function deleteLink(col, docId) {
    if(localStorage.getItem(ADMIN_TOKEN_KEY) !== 'true') return alert("Yetkisiz iÅŸlem.");
    
    if (confirm("Bu linki silmek istediÄŸinizden emin misiniz?")) {
        const linkElement = document.getElementById(`link-item-${docId}`);
        if(linkElement) linkElement.style.display = 'none';

        db.collection(col).doc(docId).delete().then(() => {
            alert("Link baÅŸarÄ±yla silindi.");
        }).catch(error => {
            console.error("Silme hatasÄ±: ", error);
            alert("Silme sÄ±rasÄ±nda bir hata oluÅŸtu.");
            if(linkElement) linkElement.style.display = 'block';
        });
    }
}

async function clearCollection(col, name) {
    if(localStorage.getItem(ADMIN_TOKEN_KEY) !== 'true') return alert("Yetkisiz iÅŸlem.");

    if (!confirm(`DÄ°KKAT! ${name} kategorisindeki TÃœM kayÄ±tlarÄ± silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.`)) {
        return;
    }

    try {
        const snapshot = await db.collection(col).get();
        if (snapshot.empty) {
            alert(`${name} kategorisinde silinecek kayÄ±t bulunamadÄ±.`);
            return;
        }

        const batch = db.batch();
        snapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
        });

        await batch.commit();
        alert(`${name} kategorisindeki ${snapshot.size} adet kayÄ±t baÅŸarÄ±yla temizlendi!`);
    } catch (error) {
        console.error("Toplu silme hatasÄ±: ", error);
        alert(`Toplu silme sÄ±rasÄ±nda bir hata oluÅŸtu: ${error.message}`);
    }
}

// === LÄ°NK GÃ–RÃœNTÃœLEME VE ARAMA SÄ°STEMÄ° ===

function showLinks(col, container){
    db.collection(col).orderBy("timestamp","desc").limit(20).onSnapshot(snapshot=>{
        
        allLinksData = allLinksData.filter(d => d.col !== col); 
        
        snapshot.forEach(doc => {
            const d = doc.data();
            d.id = doc.id;
            d.col = col;
            allLinksData.push(d); 
        });
        
        renderLinks(allLinksData.filter(d => d.col === col), container);
    });
}

function renderLinks(links, container, searchTerm = "") {
    const c = document.getElementById(container);
    c.innerHTML = ""; 
    const isAdmin = localStorage.getItem(ADMIN_TOKEN_KEY) === 'true';
    const now = new Date().getTime();
    const noLinkMessage = '<p style="font-style: italic; color: #777; text-align: center;">HenÃ¼z link eklenmemiÅŸ.</p>';
    
    const filteredLinks = links.filter(d => {
        const isExpired = d.expiryTime && d.expiryTime > 0 && d.expiryTime < now;
        
        if (isExpired) {
            db.collection(d.col).doc(d.id).delete().catch(e => console.error("Oto Silme HatasÄ±:", e));
            return false;
        }
        
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            return d.desc.toLowerCase().includes(term) || d.link.toLowerCase().includes(term);
        }
        return true;
    }).slice(0, 20);

    if (filteredLinks.length === 0) { 
        c.innerHTML = searchTerm ? '<p style="font-style: italic; color: #777; text-align: center;">Arama sonucu bulunamadÄ±.</p>' : noLinkMessage;
        return; 
    }

    filteredLinks.forEach(d => {
        const docId = d.id;
        const div=document.createElement("div");
        div.classList.add("linkItem");
        div.id = `link-item-${docId}`;
        
        const date = d.timestamp ? new Date(d.timestamp.seconds * 1000) : new Date();
        const timeStr = date.toLocaleString('tr-TR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        
        let status = `Eklendi: ${timeStr}`;
        
        if (d.expiryTime && d.expiryTime > 0) {
            const timeLeft = Math.max(0, d.expiryTime - now);
            if (timeLeft > 0) {
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                status = `<span style="color: #28a745;">Kalan SÃ¼re: ${days}G ${hours}S ${minutes}D</span>`;
            } else {
                status = `<span style="color: #dc3545;">SÃ¼resi Bitti</span>`;
            }
        }

        const deleteButtonHtml = isAdmin ? 
            `<button onclick="deleteLink('${d.col}', '${docId}')" style="margin-left: 10px; padding: 5px 10px; background-color: #d9534f; color: white; border: none; border-radius: 4px; cursor: pointer;">Sil</button>` : 
            '';
        
        div.innerHTML=`
            <a href="${d.link}" target="_blank">${d.desc}</a>
            <span>${status}</span>
            ${deleteButtonHtml}
        `;
        c.appendChild(div);
    });
}

function searchLinks() {
    const term = document.getElementById("linkSearch").value.toLowerCase();
    
    const filteredDaily = allLinksData.filter(d => d.col === "dailyLinks" && (d.desc.toLowerCase().includes(term) || d.link.toLowerCase().includes(term)));
    const filteredBig4 = allLinksData.filter(d => d.col === "big4Links" && (d.desc.toLowerCase().includes(term) || d.link.toLowerCase().includes(term)));
    const filteredGoal = allLinksData.filter(d => d.col === "goalLinks" && (d.desc.toLowerCase().includes(term) || d.link.toLowerCase().includes(term)));
    const filteredShort = allLinksData.filter(d => d.col === "shortSummary" && (d.desc.toLowerCase().includes(term) || d.link.toLowerCase().includes(term)));
    const filteredLong = allLinksData.filter(d => d.col === "longSummary" && (d.desc.toLowerCase().includes(term) || d.link.toLowerCase().includes(term)));

    renderLinks(filteredDaily, "dailyLinks", term);
    renderLinks(filteredBig4, "big4Links", term);
    renderLinks(filteredGoal, "goalLinks", term);
    renderLinks(filteredShort, "shortSummary", term);
    renderLinks(filteredLong, "longSummary", term);
}

function showAllLinks() {
    showLinks("dailyLinks","dailyLinks");
    showLinks("big4Links","big4Links");
    showLinks("goalLinks","goalLinks");
    showLinks("shortSummary","shortSummary");
    showLinks("longSummary","longSummary");
}

showAllLinks();

// BAÅLIK GÃœNCELLEME FONKSÄ°YONU
function updateDailyLinksHeader() {
    const today = new Date();
    const formattedDate = today.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    
    const headerElement = document.getElementById("dailyLinksHeader");
    if (headerElement) {
        headerElement.innerHTML = `âš½ GÃ¼nlÃ¼k MaÃ§ Linkleri - <span style="font-size: 0.9em; color: #dc3545;">${formattedDate}</span>`;
    }
}

// LÄ°NK EKLEME FONKSÄ°YONLARI
function addDailyLink(){ 
    addLink("dailyLinks","dailyLink","dailyDesc", "dailyHasDeadline", "dailyDeadline"); 
}
function addBig4Link(){ 
    addLink("big4Links","big4Link","big4Desc", "big4HasDeadline", "big4Deadline"); 
}
function addGoalLink(){ 
    addLink("goalLinks","goalLink","goalDesc", "goalHasDeadline", "goalDeadline"); 
}
function addShortSummary(){ 
    addLink("shortSummary","shortLink","shortDesc", "summaryHasDeadline", "summaryDeadline"); 
}
function addLongSummary(){ 
    addLink("longSummary","longLink","longDesc", "summaryHasDeadline", "summaryDeadline"); 
}

// === GERÄ° SAYIM FONKSÄ°YONLARI ===
function deleteNextMatch(docId) {
    if(localStorage.getItem(ADMIN_TOKEN_KEY) !== 'true') return alert("Yetkisiz iÅŸlem.");
    if (confirm("Bu geri sayÄ±mÄ± silmek istediÄŸinizden emin misiniz?")) {
        db.collection("nextMatches").doc(docId).delete().then(() => {
            alert("Geri sayÄ±m baÅŸarÄ±yla silindi.");
        }).catch(error => { console.error("Silme hatasÄ±: ", error); alert("Silme sÄ±rasÄ±nda bir hata oluÅŸtu."); });
    }
}
function updateCountdown(docId, targetTime, description, element) {
    const now = new Date().getTime(); const distance = targetTime - now;
    if (distance < 0) { clearInterval(matchIntervals[docId]); element.innerHTML = `<p style="color: #d9534f; font-weight: bold;">${description}</p>MAÃ‡ BAÅLADI VEYA BÄ°TTÄ°!`; return; }
    const days = Math.floor(distance / (1000 * 60 * 60 * 24)); const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)); const seconds = Math.floor((distance % (1000 * 60)) / 1000);
    element.innerHTML = `<p style="font-size: 1.2em; font-weight: bold;">${description}</p>${days}G ${hours}S ${minutes}D ${seconds}SN`;
}
function startCountdown(docId, targetTime, description) {
    const isAdmin = localStorage.getItem(ADMIN_TOKEN_KEY) === 'true'; 
    const container = document.getElementById("allNextMatchesContainer");
    if (matchIntervals[docId]) clearInterval(matchIntervals[docId]);
    let timerItem = document.getElementById(`timer-item-${docId}`);
    if (!timerItem) {
        timerItem = document.createElement('div'); timerItem.classList.add('timerItem'); timerItem.id = `timer-item-${docId}`;
        const countdownDisplay = document.createElement('div'); countdownDisplay.id = `countdown-${docId}`; timerItem.appendChild(countdownDisplay); container.appendChild(timerItem);
    } 
    const countdownDisplay = document.getElementById(`countdown-${docId}`);
    let deleteBtn = timerItem.querySelector('button');
    if (isAdmin) {
        if(!deleteBtn) { deleteBtn = document.createElement('button'); deleteBtn.innerHTML = 'Sil'; deleteBtn.style.backgroundColor = '#d9534f'; deleteBtn.onclick = () => deleteNextMatch(docId); timerItem.appendChild(deleteBtn); }
    } else if (deleteBtn) { deleteBtn.remove(); }
    updateCountdown(docId, targetTime, description, countdownDisplay);
    matchIntervals[docId] = setInterval(() => { updateCountdown(docId, targetTime, description, countdownDisplay); }, 1000);
}
function showNextMatches() {
    db.collection("nextMatches").orderBy("targetTime", "asc").onSnapshot(snapshot => {
        const container = document.getElementById("allNextMatchesContainer");
        const currentIds = new Set();
        snapshot.forEach(doc => {
            currentIds.add(doc.id);
            const data = doc.data();
            if (data.targetTime) { startCountdown(doc.id, data.targetTime, data.description || "MaÃ§ ZamanÄ±!"); }
        });
        const existingTimers = Object.keys(matchIntervals);
        existingTimers.forEach(id => {
            if (!currentIds.has(id)) { clearInterval(matchIntervals[id]); delete matchIntervals[id]; const element = document.getElementById(`timer-item-${id}`); if (element) element.remove(); }
        });
        if (snapshot.empty) { container.innerHTML = '<p style="font-style: italic; color: #777;">HenÃ¼z geri sayÄ±m eklenmemiÅŸ.</p>'; }
    });
}
function addNextMatch() {
    if(localStorage.getItem(ADMIN_TOKEN_KEY) !== 'true') return alert("Sadece admin ayar yapabilir!");
    const targetDateInput = document.getElementById("newMatchDate").value; const description = document.getElementById("newMatchText").value;
    if (!targetDateInput || !description) return alert("Tarih ve aÃ§Ä±klama girmelisiniz.");
    const targetTime = new Date(targetDateInput).getTime();
    if (targetTime < new Date().getTime()) return alert("GeÃ§miÅŸ bir zaman ayarlayamazsÄ±nÄ±z.");
    db.collection("nextMatches").add({ targetTime: targetTime, description: description, timestamp: firebase.firestore.FieldValue.serverTimestamp() }).then(() => {
        alert("Yeni geri sayÄ±m eklendi!"); document.getElementById("newMatchDate").value = ''; document.getElementById("newMatchText").value = '';
    }).catch(error => { console.error("Geri sayÄ±m ekleme hatasÄ±: ", error); alert("Geri sayÄ±m eklenirken bir hata oluÅŸtu. Firebase kurallarÄ±nÄ±zÄ± kontrol edin."); });
}

// === Ã‡OKLU DUYURU FONKSÄ°YONLARI ===

function addAnnouncement() {
    if(localStorage.getItem(ADMIN_TOKEN_KEY) !== 'true') return alert("Yetkisiz iÅŸlem.");
    const text = document.getElementById("newAnnouncementText").value;
    if (!text) return alert("Duyuru metni boÅŸ olamaz.");

    db.collection("announcements").add({ text: text, timestamp: firebase.firestore.FieldValue.serverTimestamp() })
        .then(() => {
            alert("Yeni duyuru eklendi.");
            document.getElementById("newAnnouncementText").value = '';
        })
        .catch(error => {
            console.error("Duyuru ekleme hatasÄ±: ", error);
            alert("Duyuru eklenirken hata oluÅŸtu. Firebase kurallarÄ±nÄ±zÄ± kontrol edin!");
        });
}

function deleteAnnouncement(docId) {
    if(localStorage.getItem(ADMIN_TOKEN_KEY) !== 'true') return alert("Yetkisiz iÅŸlem.");
    if (confirm("Bu duyuruyu silmek istediÄŸinizden emin misiniz?")) {
        db.collection("announcements").doc(docId).delete().then(() => {
            alert("Duyuru baÅŸarÄ±yla silindi.");
        }).catch(error => {
            console.error("Duyuru silme hatasÄ±: ", error);
            alert("Duyuru silinirken hata oluÅŸtu. Firebase kurallarÄ±nÄ±zÄ± kontrol edin!");
        });
    }
}

function loadAdminAnnouncements() {
    db.collection("announcements").orderBy("timestamp", "desc").onSnapshot(snapshot => {
        const container = document.getElementById("currentAnnouncements");
        container.innerHTML = '<h5>Mevcut Duyurular:</h5>';
        if (snapshot.empty) {
            container.innerHTML += '<p style="font-style: italic; color: #777;">HenÃ¼z duyuru yok.</p>';
            return;
        }
        snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement('div');
            div.innerHTML = `${data.text} <button onclick="deleteAnnouncement('${doc.id}')" style="background-color: #f44336; padding: 3px 6px; font-size: 10px;">Sil</button>`;
            container.appendChild(div);
        });
    }, error => {
        console.error("Admin DuyurularÄ± Ã§ekme hatasÄ±: ", error);
    });
}

function loadAnnouncements() {
    db.collection("announcements").orderBy("timestamp", "desc").onSnapshot(snapshot => {
        announcementData = [];
        snapshot.forEach(doc => {
            announcementData.push(doc.data().text);
        });

        const bar = document.getElementById("announcementBar");
        bar.innerHTML = "";
        currentAnnouncementIndex = 0;

        if (announcementData.length > 0) {
            bar.style.display = 'block';
            announcementData.forEach((text, index) => {
                const item = document.createElement('div');
                item.classList.add('announcement-item');
                item.textContent = text;
                bar.appendChild(item);
                if (index === 0) item.classList.add('active');
            });

            if (announcementData.length > 1) {
                if (window.announcementInterval) clearInterval(window.announcementInterval);
                window.announcementInterval = setInterval(showNextAnnouncement, 5000); 
            }
        } else {
            bar.style.display = 'none';
            if (window.announcementInterval) clearInterval(window.announcementInterval);
        }
    }, error => {
        console.error("DuyurularÄ± yÃ¼kleme hatasÄ±: ", error);
    });
}

function showNextAnnouncement() {
    const items = document.querySelectorAll('.announcement-item');
    if (items.length === 0) return;

    items[currentAnnouncementIndex].classList.remove('active');
    currentAnnouncementIndex = (currentAnnouncementIndex + 1) % items.length;
    items[currentAnnouncementIndex].classList.add('active');
}

// === SÃœRÃœM BÄ°LGÄ°SÄ° VE GEÃ‡MÄ°Å YÃ–NETÄ°MÄ° (GÃœNCELLENDÄ°) ===
function setVersionInfo() {
    if(localStorage.getItem(ADMIN_TOKEN_KEY) !== 'true') return alert("Yetkisiz iÅŸlem.");
    const version = document.getElementById("versionNo").value;
    const notes = document.getElementById("updateNotes").value;
    
    if (!version || !notes) return alert("SÃ¼rÃ¼m No ve GÃ¼ncelleme NotlarÄ± boÅŸ bÄ±rakÄ±lamaz.");

    db.collection("versions").add({ 
        version: version, 
        notes: notes, 
        timestamp: firebase.firestore.FieldValue.serverTimestamp() 
    }).then(() => { 
        alert(`SÃ¼rÃ¼m ${version} baÅŸarÄ±yla kaydedildi!`);
        document.getElementById("versionNo").value = '';
        document.getElementById("updateNotes").value = '';
        loadVersionHistory(); // GeÃ§miÅŸi yeniden yÃ¼kle
    }).catch(error => {
        console.error("SÃ¼rÃ¼m kaydetme hatasÄ±: ", error);
        alert("SÃ¼rÃ¼m kaydedilirken bir hata oluÅŸtu.");
    });
}

function deleteVersion(docId) {
    if(localStorage.getItem(ADMIN_TOKEN_KEY) !== 'true') return alert("Yetkisiz iÅŸlem.");
    if (!confirm("Bu sÃ¼rÃ¼m bilgisini silmek istediÄŸinizden emin misiniz?")) return;
    
    db.collection("versions").doc(docId).delete().then(() => {
        alert("SÃ¼rÃ¼m bilgisi silindi.");
    }).catch(error => {
        console.error("Silme hatasÄ±: ", error);
        alert("Silme sÄ±rasÄ±nda bir hata oluÅŸtu.");
    });
}

function loadVersionHistory() {
    db.collection("versions").orderBy("timestamp", "desc").onSnapshot(snapshot => {
        const list = document.getElementById("versionHistoryList");
        const isAdmin = localStorage.getItem(ADMIN_TOKEN_KEY) === 'true';
        
        list.innerHTML = '';
        if (snapshot.empty) {
            list.innerHTML = '<p style="font-style: italic; color: #777;">HenÃ¼z sÃ¼rÃ¼m bilgisi eklenmemiÅŸ.</p>';
            return;
        }

        snapshot.forEach(doc => {
            const data = doc.data();
            const dateStr = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString('tr-TR') : 'Bilinmiyor';
            
            const item = document.createElement('div');
            item.classList.add('version-item');
            
            const deleteBtnHtml = isAdmin ? 
                `<button onclick="deleteVersion('${doc.id}')" style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; float: right;">Sil</button>` : 
                '';

            item.innerHTML = `
                ${deleteBtnHtml}
                <h5>${data.version} (${dateStr})</h5>
                <p>${data.notes}</p>
            `;
            list.appendChild(item);
        });
    });
}

// Modal FonksiyonlarÄ±
function openVersionModal() {
    loadVersionHistory();
    document.getElementById('versionModal').style.display = 'block';
}

function closeVersionModal() {
    document.getElementById('versionModal').style.display = 'none';
}

// Pencere dÄ±ÅŸÄ±nda tÄ±klanÄ±rsa kapatma
window.onclick = function(event) {
    const modal = document.getElementById('versionModal');
    if (event.target == modal) {
        modal.style.display = "none";
    }
}
// SON SÃœRÃœM BÄ°LGÄ°SÄ° GÃœNCELLEMESÄ°


// === GERÄ° BÄ°LDÄ°RÄ°M FONKSÄ°YONLARI (YENÄ°) ===
function submitFeedback() {
    const name = document.getElementById("feedbackName").value.trim();
    const email = document.getElementById("feedbackEmail").value.trim();
    const message = document.getElementById("feedbackMessage").value.trim();

    if (!name || !message) {
        return alert("AdÄ±nÄ±z ve mesajÄ±nÄ±z boÅŸ bÄ±rakÄ±lamaz.");
    }

    db.collection("feedbacks").add({
        name: name,
        email: email,
        message: message,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        isRead: false
    }).then(() => {
        alert("Geri bildiriminiz baÅŸarÄ±yla gÃ¶nderildi. TeÅŸekkÃ¼r ederiz! ğŸ˜Š");
        document.getElementById("feedbackName").value = '';
        document.getElementById("feedbackEmail").value = '';
        document.getElementById("feedbackMessage").value = '';
    }).catch(error => {
        console.error("Geri bildirim gÃ¶nderme hatasÄ±: ", error);
        alert("Geri bildirim gÃ¶nderilirken bir hata oluÅŸtu.");
    });
}


// === BÄ°LDÄ°RÄ°M Ä°ZÄ°NLERÄ° ===
function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission !== 'granted') {
        Notification.requestPermission().then(permission => { console.log(`Bildirim izni: ${permission}`); });
    }
}
function sendNotification(title, body) {
    if (Notification.permission === 'granted') { new Notification(title, { body: body, icon: '/favicon.ico' }); }
}
let lastDailyLinkTimestamp = 0;
db.collection("dailyLinks").orderBy("timestamp", "desc").limit(1).onSnapshot(snapshot => {
    snapshot.forEach(doc => {
        const d = doc.data(); 
        if (!d.timestamp) return;
        const currentTimestamp = d.timestamp.seconds;
        if (lastDailyLinkTimestamp !== 0 && currentTimestamp > lastDailyLinkTimestamp) { sendNotification("âš½ Yeni MaÃ§ Linki Eklendi!", d.desc); }
        lastDailyLinkTimestamp = currentTimestamp;
    });
});

// ===============================================
// ğŸ§  QUIZ FONKSÄ°YONLARI
// ===============================================

function addQuizOption() {
    const container = document.getElementById("quizOptionsContainer");
    const optionCount = container.children.length;
    const newOptionId = `quizOption${optionCount + 1}`;
    
    const optionDiv = document.createElement("div");
    optionDiv.className = "option-control";
    optionDiv.innerHTML = `
        <input id="${newOptionId}" placeholder="SeÃ§enek ${optionCount + 1}">
        <button type="button" class="remove-option" onclick="removeQuizOption(this)">Sil</button>
    `;
    container.appendChild(optionDiv);
    
    updateQuizCorrectOptions();
}

function removeQuizOption(button) {
    const container = document.getElementById("quizOptionsContainer");
    if (container.children.length <= 2) {
        alert("En az iki seÃ§enek olmalÄ±dÄ±r!");
        return;
    }
    
    button.parentElement.remove();
    updateQuizCorrectOptions();
}

function updateQuizCorrectOptions() {
    const container = document.getElementById("quizOptionsContainer");
    const select = document.getElementById("quizCorrectOption");
    const currentValue = select.value;
    
    select.innerHTML = '';
    
    for (let i = 0; i < container.children.length; i++) {
        const option = document.createElement("option");
        option.value = i + 1;
        option.textContent = `DoÄŸru Cevap: SeÃ§enek ${i + 1}`;
        select.appendChild(option);
    }
    
    if (currentValue && parseInt(currentValue) <= container.children.length) {
        select.value = currentValue;
    }
}

function createQuiz() {
    if(localStorage.getItem(ADMIN_TOKEN_KEY) !== 'true') return alert("Yetkisiz iÅŸlem.");
    
    const question = document.getElementById("quizQuestion").value;
    const correctOption = document.getElementById("quizCorrectOption").value;
    
    const container = document.getElementById("quizOptionsContainer");
    const options = [];
    for (let i = 0; i < container.children.length; i++) {
        const input = container.children[i].querySelector('input');
        if (input && input.value.trim()) {
            options.push(input.value.trim());
        }
    }

    if (!question || options.length < 2 || !correctOption) {
        return alert("Soru, en az iki seÃ§enek ve doÄŸru cevap belirtmelisiniz!");
    }

    let startTime = null;
    let deadline = null;
    const hasDeadline = document.getElementById("quizHasDeadline").checked;
    if (hasDeadline) {
        const startTimeValue = document.getElementById("quizStartTime").value;
        const deadlineValue = document.getElementById("quizDeadline").value;
        
        if (!startTimeValue || !deadlineValue) {
            return alert("BaÅŸlangÄ±Ã§ ve bitiÅŸ tarihlerini belirtmelisiniz!");
        }
        
        startTime = new Date(startTimeValue).getTime();
        deadline = new Date(deadlineValue).getTime();
        
        if (startTime >= deadline) {
            return alert("BitiÅŸ tarihi baÅŸlangÄ±Ã§ tarihinden sonra olmalÄ±dÄ±r!");
        }
    }

    const quizData = {
        isActive: true,
        question: question,
        options: options,
        correctOption: parseInt(correctOption),
        startTime: startTime,
        deadline: deadline,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    db.collection("quiz").doc("activeQuiz").set(quizData)
        .then(() => {
            alert("Quiz baÅŸarÄ±yla baÅŸlatÄ±ldÄ±/gÃ¼ncellendi!");
        }).catch(error => { 
            console.error("Quiz baÅŸlatma hatasÄ±: ", error); 
            alert("Quiz baÅŸlatÄ±lÄ±rken hata oluÅŸtu. Firebase kurallarÄ±nÄ±zÄ± kontrol edin."); 
        });
}

function deleteQuiz() {
    if(localStorage.getItem(ADMIN_TOKEN_KEY) !== 'true') return alert("Yetkisiz iÅŸlem.");
    if (!confirm("Quizi kapatmak istediÄŸinizden emin misiniz?")) return;

    db.collection("quiz").doc("activeQuiz").update({ isActive: false })
        .then(() => {
            alert("Quiz kapatÄ±ldÄ±. SonuÃ§lar gÃ¶rÃ¼nÃ¼r kalacaktÄ±r.");
        }).catch(error => { console.error("Quiz kapatma hatasÄ±: ", error); alert("Quiz kapatÄ±lÄ±rken hata oluÅŸtu. Firebase kurallarÄ±nÄ±zÄ± kontrol edin."); });
}

function submitQuizAnswer(name, selectedOption, quizId) {
    if (!name.trim()) return alert("AdÄ±nÄ±zÄ± girmelisiniz!");
    
    const answerData = {
        name: name,
        selectedOption: selectedOption,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    db.collection("quizAnswers").doc(name).set(answerData)
        .then(() => {
            alert("CevabÄ±nÄ±z kaydedildi!");
            localStorage.setItem("quizUserName", name);
            showQuizResults(currentQuiz.id, currentQuiz.data, name, selectedOption);
        })
        .catch(error => {
            alert("Cevap kaydedilirken hata oluÅŸtu. LÃ¼tfen tekrar deneyin. (AdÄ±nÄ±z daha Ã¶nce kullanÄ±lmÄ±ÅŸ olabilir)");
            console.error(error);
        });
}

function updateQuizCountdown(docId, targetTime, isStartTime = false) {
    const element = document.getElementById(`quizCountdown-${docId}`);
    if (!element) return;
    
    const now = new Date().getTime(); 
    const distance = targetTime - now;

    if (distance < 0) { 
        clearInterval(quizInterval); 
        if (isStartTime) {
            element.innerHTML = `<span style="color: #28a745; font-weight: bold;">QUIZ BAÅLADI!</span>`;
            setTimeout(() => {
                loadActiveQuiz();
            }, 2000);
        } else {
            element.innerHTML = `<span style="color: #dc3545; font-weight: bold;">SÃœRE BÄ°TTÄ°, SONUÃ‡LAR GÃ–STERÄ°LÄ°YOR!</span>`; 
            showQuizResults(currentQuiz.id, currentQuiz.data, localStorage.getItem("quizUserName") || "", null, true);
        }
        return; 
    }
    
    const days = Math.floor(distance / (1000 * 60 * 60 * 24)); 
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); 
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)); 
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
    
    const prefix = isStartTime ? "Quiz BaÅŸlamasÄ±na: " : "Kalan SÃ¼re: ";
    element.innerHTML = `<span style="font-weight: bold; color: #ffc107;">${prefix} ${days}G ${hours}S ${minutes}D ${seconds}SN</span>`;
}

function loadActiveQuiz() {
    db.collection("quiz").doc("activeQuiz").onSnapshot(doc => {
        const container = document.getElementById("quizGameContainer");
        const now = new Date().getTime();
        
        if (quizInterval) clearInterval(quizInterval);

        if (doc.exists && doc.data().isActive) {
            currentQuiz = { ...doc.data(), id: doc.id };
            const data = doc.data();
            const userName = localStorage.getItem("quizUserName") || "";
            
            const isNotStarted = data.startTime && now < data.startTime;
            const isDeadlineExpired = data.deadline && now > data.deadline;

            if (isNotStarted) {
                container.innerHTML = `
                    <div class="quizForm">
                        <p class="quizQuestion">${data.question}</p>
                        <div class="quiz-countdown" id="quizCountdown-${doc.id}"></div>
                        <p style="text-align: center; color: #777;">Quiz henÃ¼z baÅŸlamadÄ±. BaÅŸlangÄ±Ã§ zamanÄ±na kadar bekleyin.</p>
                    </div>
                `;
                updateQuizCountdown(doc.id, data.startTime, true);
                quizInterval = setInterval(() => updateQuizCountdown(doc.id, data.startTime, true), 1000);
                return;
            }

            if (isDeadlineExpired) {
                showQuizResults(doc.id, data, userName, null, true); 
                return;
            }

            db.collection("quizAnswers").doc(userName).get().then(answerDoc => {
                const userHasAnswered = answerDoc.exists;
                
                if (userHasAnswered) {
                    showQuizResults(doc.id, data, userName, answerDoc.data().selectedOption, false);
                } else {
                    container.innerHTML = generateQuizForm(data, userName);
                    if (data.deadline) {
                        updateQuizCountdown(doc.id, data.deadline, false);
                        quizInterval = setInterval(() => updateQuizCountdown(doc.id, data.deadline, false), 1000);
                    }
                }
            });

        } else if (doc.exists && !doc.data().isActive) {
            currentQuiz = { ...doc.data(), id: doc.id };
            showQuizResults(doc.id, currentQuiz.data, localStorage.getItem("quizUserName") || "", null, true);
        } else {
            currentQuiz = null;
            container.innerHTML = '<p style="font-style: italic; color: #777;">Åu anda aktif bir bilgi yarÄ±ÅŸmasÄ± bulunmamaktadÄ±r.</p>';
        }
    });
}

function generateQuizForm(data, userName) {
    const optionsHtml = data.options.map((opt, index) => `
        <label class="quizOption">
            <input type="radio" name="quizOption" value="${index + 1}" style="margin-right: 10px;">
            ${opt}
        </label>
    `).join('');

    let statusInfo = "";
    if (data.deadline) {
        const deadlineStr = new Date(data.deadline).toLocaleString('tr-TR');
        statusInfo = `<div class="quiz-countdown" id="quizCountdown-${data.id}"></div>
                     <p style="font-size: 12px; color: #dc3545; text-align: center;">â° Son Cevaplama: **${deadlineStr}**</p>`;
    } else {
        statusInfo = `<div class="quiz-active">Quiz admin tarafÄ±ndan kapatÄ±lana kadar devam edecektir.</div>`;
    }

    return `
        <div class="quizForm">
            <p class="quizQuestion">${data.question}</p>
            ${statusInfo}
            <input type="text" id="quizName" placeholder="AdÄ±nÄ±z (Zorunlu, Tekrar Cevap Verilemez)" value="${userName}" style="max-width: 250px; display: block; margin-bottom: 15px;">
            <div id="quizOptions">${optionsHtml}</div>
            <button onclick="
                const name = document.getElementById('quizName').value;
                const selected = document.querySelector('input[name=\\'quizOption\\']:checked');
                if(selected) { 
                    submitQuizAnswer(name, parseInt(selected.value), 'activeQuiz'); 
                } else { 
                    alert('LÃ¼tfen bir seÃ§enek iÅŸaretleyin!'); 
                }
            " style="margin-top: 20px; background-color: #5aa1e3;">CevabÄ± GÃ¶nder</button>
        </div>
    `;
}

function showQuizResults(quizId, quizData, userName, userSelectedOption = null, isExpired = false) {
    const container = document.getElementById("quizGameContainer");
    
    if (quizInterval) clearInterval(quizInterval);

    let userResultHtml = '';
    
    if (userSelectedOption) {
        const isCorrect = userSelectedOption === quizData.correctOption;
        const resultText = isCorrect ? 'DoÄŸru' : 'YanlÄ±ÅŸ';
        const color = isCorrect ? '#28a745' : '#dc3545';
        userResultHtml = `<hr><p style="font-weight: bold; color: ${color};">Sizin CevabÄ±nÄ±z: ${resultText} (${quizData.options[userSelectedOption - 1]})</p>`;
    } else if (isExpired && userName) {
        db.collection("quizAnswers").doc(userName).get().then(answerDoc => {
            if (answerDoc.exists) {
                showQuizResults(quizId, quizData, userName, answerDoc.data().selectedOption, true);
            }
        });
    }

    const backToFormButton = (isExpired || !quizData.isActive) ? '' :
        `<button onclick="loadActiveQuiz()" style="margin-top: 15px; background-color: #007bff;">Quiz'e Geri DÃ¶n</button>`;

    let statusHeader = "";
    if (isExpired) {
        statusHeader = `<div class="quiz-expired">Quiz SÃ¼resi Doldu</div>`;
    } else if (!quizData.isActive) {
        statusHeader = `<div class="quiz-expired">Quiz KapatÄ±ldÄ±</div>`;
    }

    container.innerHTML = `
        <div class="quizResults">
            ${statusHeader}
            <p class="quizQuestion">${quizData.question}</p>
            <p style="font-weight: bold; color: #28a745;">âœ… DoÄŸru Cevap: ${quizData.options[quizData.correctOption - 1]}</p>
            <hr>
            <h4 style="color: #007bff; text-align: center;">KullanÄ±cÄ± CevaplarÄ± DaÄŸÄ±lÄ±mÄ±</h4>
            <div id="quizAnswersStats">YÃ¼kleniyor...</div>
            ${userResultHtml}
            ${backToFormButton}
        </div>
    `;
    
    db.collection("quizAnswers").get().then(snapshot => {
        const stats = {};
        let total = 0;

        snapshot.forEach(doc => {
            const answer = doc.data();
            total++;
            stats[answer.selectedOption] = (stats[answer.selectedOption] || 0) + 1;
        });
        
        let resultHtml = ``;
        if (total > 0) {
            quizData.options.forEach((opt, index) => {
                const optionValue = index + 1;
                const count = stats[optionValue] || 0;
                const percentage = total > 0 ? ((count / total) * 100).toFixed(0) : 0;
                const isCorrect = optionValue === quizData.correctOption;
                const isUserVote = userSelectedOption === optionValue;
                
                resultHtml += `
                    <div style="margin-bottom: 10px; ${isUserVote ? 'border: 1px solid #007bff; padding: 5px; border-radius: 4px; background-color: #e0f7ff;' : ''}">
                        <span style="${isCorrect ? 'font-weight: bold; color: #28a745;' : ''}">${opt}</span>: ${count} Oy (%${percentage})
                        ${isUserVote ? '<span class="user-vote-indicator">SÄ°Z</span>' : ''}
                    </div>
                `;
            });
            resultHtml += `<p style="text-align: right; font-size: 12px; color: #777;">Toplam Cevap: ${total}</p>`;
        } else {
            resultHtml = "<p>HenÃ¼z cevap veren olmamÄ±ÅŸ.</p>";
        }

        document.getElementById("quizAnswersStats").innerHTML = resultHtml;
    });
}

// ===============================================
// ğŸ—³ï¸ ANKET/LÄ°NK FONKSÄ°YONLARI (BASÄ°TLEÅTÄ°RÄ°LMÄ°Å - GÃœNCELLENDÄ°)
// ===============================================

let currentPoll = null;

function createPoll() {
    if(localStorage.getItem(ADMIN_TOKEN_KEY) !== 'true') return alert("Yetkisiz iÅŸlem.");
    
    const link = document.getElementById("pollLink").value;
    const desc = document.getElementById("pollDesc").value;

    if (!link || !desc) {
        return alert("Link ve aÃ§Ä±klama zorunludur!");
    }

    let deadline = 0;
    const hasDeadline = document.getElementById("pollHasDeadline").checked;
    if (hasDeadline) {
        const deadlineValue = document.getElementById("pollDeadline").value;
        if (!deadlineValue) { return alert("BitiÅŸ tarihi belirtmelisiniz!"); }
        deadline = new Date(deadlineValue).getTime();
        if (deadline <= new Date().getTime()) { return alert("BitiÅŸ tarihi ÅŸu andan sonra olmalÄ±dÄ±r!"); }
    }

    const pollData = {
        isActive: true,
        link: link,
        description: desc,
        deadline: deadline,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    db.collection("poll").doc("activePoll").set(pollData)
        .then(() => {
            alert("Duyuru Linki baÅŸarÄ±yla baÅŸlatÄ±ldÄ±/gÃ¼ncellendi!");
        }).catch(error => { 
            console.error("Duyuru Linki baÅŸlatma hatasÄ±: ", error); 
            alert("Duyuru Linki baÅŸlatÄ±lÄ±rken hata oluÅŸtu."); 
        });
}

function deletePoll() {
    if(localStorage.getItem(ADMIN_TOKEN_KEY) !== 'true') return alert("Yetkisiz iÅŸlem.");
    if (!confirm("Duyuru Linkini kapatmak istediÄŸinizden emin misiniz?")) return;

    db.collection("poll").doc("activePoll").update({ isActive: false, deadline: 0, link: "", description: "" })
        .then(() => {
            alert("Duyuru Linki kapatÄ±ldÄ±.");
        }).catch(error => { console.error("Duyuru Linki kapatma hatasÄ±: ", error); alert("Duyuru Linki kapatÄ±lÄ±rken hata oluÅŸtu."); });
}

function updatePollCountdown(docId, targetTime, description) {
    const element = document.getElementById(`pollCountdown-${docId}`);
    if (!element) return;
    
    const now = new Date().getTime(); 
    const distance = targetTime - now;

    if (distance < 0) { 
        clearInterval(pollInterval); 
        element.classList.remove('poll-countdown');
        element.classList.add('poll-expired');
        element.innerHTML = `SÃœRE BÄ°TTÄ°: "${description}" Linki KaldÄ±rÄ±ldÄ±.`; 
        setTimeout(() => {
            db.collection("poll").doc("activePoll").update({ isActive: false, deadline: 0 }).catch(e => console.error("Poll oto kapatma hatasÄ±:", e));
        }, 3000);
        return; 
    }
    
    const days = Math.floor(distance / (1000 * 60 * 60 * 24)); 
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); 
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)); 
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
    
    element.innerHTML = `â° Kalan SÃ¼re: ${days}G ${hours}S ${minutes}D ${seconds}SN`;
}

function loadActivePoll() {
    db.collection("poll").doc("activePoll").onSnapshot(doc => {
        const container = document.getElementById("pollGameContainer");
        const now = new Date().getTime();

        if (pollInterval) clearInterval(pollInterval);

        if (doc.exists && doc.data().isActive) {
            currentPoll = doc.data();
            const data = doc.data();
            const isDeadlineExpired = data.deadline && data.deadline > 0 && now > data.deadline;
            
            if (isDeadlineExpired) {
                // SÃ¼resi dolduysa admin tarafÄ±ndan pasifize edilecek, bu ekranda sadece uyarÄ± gÃ¶ster
                container.innerHTML = `<p style="font-style: italic; color: #dc3545; text-align: center;">Ã–nceki linkin sÃ¼resi doldu ve kaldÄ±rÄ±ldÄ±.</p>`;
                return;
            }

            container.innerHTML = `
                <p class="pollQuestion" style="text-align: center; color: #dc3545; font-size: 1.1em;">ğŸ“£ Ã–NEMLÄ° DUYURU/LÄ°NK</p>
                <div style="padding: 15px; border: 1px solid #007bff; border-radius: 8px; background-color: #e0f7ff;">
                    <a href="${data.link}" target="_blank" style="font-size: 1.2em; color: #0033cc; font-weight: bold; text-decoration: underline; margin-bottom: 10px;">
                        ${data.description}
                    </a>
                    ${data.deadline && data.deadline > 0 ? `<div class="poll-countdown" id="pollCountdown-activePoll"></div>` : `<div class="poll-active">SÃ¼resiz Duyuru</div>`}
                </div>
            `;
            
            if (data.deadline && data.deadline > 0) {
                updatePollCountdown("activePoll", data.deadline, data.description);
                pollInterval = setInterval(() => updatePollCountdown("activePoll", data.deadline, data.description), 1000);
            }

        } else {
            currentPoll = null;
            container.innerHTML = '<p style="font-style: italic; color: #777; text-align: center;">Åu anda aktif bir duyuru/link bulunmamaktadÄ±r.</p>';
        }
    }, error => {
        console.error("Duyuru Linki yÃ¼kleme hatasÄ±:", error);
        container.innerHTML = '<p style="font-style: italic; color: #777; text-align: center;">Ä°Ã§erik yÃ¼klenirken hata oluÅŸtu.</p>';
    });
}
// SON ANKET/LÄ°NK GÃœNCELLEMESÄ°


// ===============================================
// ğŸ† TAHMÄ°N OYUNU FONKSÄ°YONLARI
// ===============================================

function createPredictionGame() {
    if(localStorage.getItem(ADMIN_TOKEN_KEY) !== 'true') return alert("Sadece admin oluÅŸturabilir!");
    
    const matchName = document.getElementById("tahminMatchName").value;
    const teamA = document.getElementById("tahminTeamA").value;
    const teamB = document.getElementById("tahminTeamB").value;
    const deadline = document.getElementById("tahminDeadline").value;

    if (!matchName || !teamA || !teamB || !deadline) {
        return alert("MaÃ§ adÄ±, takÄ±mlar ve bitiÅŸ tarihi boÅŸ bÄ±rakÄ±lamaz.");
    }

    const gameData = {
        isActive: true,
        matchName: matchName,
        teamA: teamA,
        teamB: teamB,
        deadline: new Date(deadline).getTime(),
        results: null, 
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    db.collection("predictionGame").doc("activeGame").set(gameData)
        .then(() => {
            alert("Tahmin Oyunu baÅŸarÄ±yla baÅŸlatÄ±ldÄ±/gÃ¼ncellendi!");
        }).catch(error => { console.error("Oyun baÅŸlatma hatasÄ±: ", error); alert("Oyun baÅŸlatÄ±lÄ±rken hata oluÅŸtu. Firebase kurallarÄ±nÄ±zÄ± kontrol edin."); });
}

function loadPredictionGameSettings() {
    db.collection("predictionGame").doc("activeGame").get().then(doc => {
        if (doc.exists && doc.data().isActive) {
            const data = doc.data();
            document.getElementById("tahminMatchName").value = data.matchName;
            document.getElementById("tahminTeamA").value = data.teamA;
            document.getElementById("tahminTeamB").value = data.teamB;
            
            if (data.deadline) {
                const date = new Date(data.deadline);
                const localISO = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                document.getElementById("tahminDeadline").value = localISO;
            }
        }
    });
}

function publishPredictionResults() {
    if(localStorage.getItem(ADMIN_TOKEN_KEY) !== 'true') return alert("Yetkisiz iÅŸlem.");

    const scoreA = parseInt(document.getElementById("resultScoreA").value);
    const scoreB = parseInt(document.getElementById("resultScoreB").value);
    const matchResult = document.getElementById("resultMatchResult").value;
    const goalCount = document.getElementById("resultGoalCount").value;
    const cardCount = document.getElementById("resultCardCount").value;
    const gameId = "activeGame";

    if (isNaN(scoreA) || isNaN(scoreB) || matchResult === 'none' || goalCount === 'none' || cardCount === 'none') {
        return alert("TÃ¼m sonuÃ§ alanlarÄ±nÄ± doldurmalÄ±sÄ±nÄ±z!");
    }

    const results = {
        scoreA: scoreA,
        scoreB: scoreB,
        matchResult: matchResult, 
        goalCount: goalCount,     
        cardCount: cardCount,     
        published: true 
    };

    db.collection("predictionGame").doc(gameId).update({ results: results })
        .then(() => {
            calculateWinnersAndSetWeeklyChampion(gameId, results);
            alert("MaÃ§ sonuÃ§larÄ± kaydedildi! Kazananlar listede gÃ¶steriliyor.");
        }).catch(error => { console.error("SonuÃ§ yayÄ±nlama hatasÄ±: ", error); alert("SonuÃ§ yayÄ±nlanÄ±rken hata oluÅŸtu. Firebase kurallarÄ±nÄ±zÄ± kontrol edin."); });
}

function calculateWinnersAndSetWeeklyChampion(gameId, results) {
    db.collection("predictionGame").doc(gameId).collection("predictions").get()
        .then(snapshot => {
            let winners = [];
            snapshot.forEach(doc => {
                const p = doc.data();
                let points = 0;
                
                if (p.scoreA === results.scoreA && p.scoreB === results.scoreB) { points += 5; } 
                if (p.matchResult === results.matchResult) { points += 2; }
                if (p.goalCount === results.goalCount) { points += 1; }
                if (p.cardCount === results.cardCount) { points += 1; }

                if (points > 0) {
                    winners.push({ name: p.name, points: points });
                }
            });

            winners.sort((a, b) => b.points - a.points);
            
            if (winners.length > 0) {
                const maxPoints = winners[0].points;
                const topWinners = winners.filter(w => w.points === maxPoints);
                const winnerNames = topWinners.map(w => w.name).join(' & ');
                const expiryTime = new Date().getTime() + (7 * 24 * 60 * 60 * 1000); 
                
                db.collection("settings").doc("predictionWinner").set({
                    name: winnerNames,
                    points: maxPoints,
                    expiryTime: expiryTime,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    console.log("HaftalÄ±k kazanan ayarlandÄ±:", winnerNames);
                });
            }
        });
}

function loadWeeklyWinner() {
    db.collection("settings").doc("predictionWinner").onSnapshot(doc => {
        const winnerDiv = document.getElementById("weeklyWinner");
        winnerDiv.style.display = 'none';

        if (doc.exists) {
            const data = doc.data();
            const now = new Date().getTime();
            
            if (data.expiryTime && data.expiryTime > now) {
                const timeLeft = data.expiryTime - now;
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

                winnerDiv.style.display = 'block';
                winnerDiv.innerHTML = `
                    ğŸ‘‘ **HAFTANIN ÅAMPÄ°YONU:** ${data.name} (${data.points} Puan!) 
                    <span style="font-size: 11px;">(Kalan SÃ¼re: ${days}G ${hours}S)</span>
                `;

                if (window.winnerInterval) clearInterval(window.winnerInterval);
                window.winnerInterval = setInterval(loadWeeklyWinner, 1000 * 60); 
            } else if (data.expiryTime && data.expiryTime <= now) {
                db.collection("settings").doc("predictionWinner").delete().catch(e => console.error("Winner silme hatasÄ±", e));
                if (window.winnerInterval) clearInterval(window.winnerInterval);
            }
        }
    });
}

function deletePredictionGame() {
    if(localStorage.getItem(ADMIN_TOKEN_KEY) !== 'true') return alert("Yetkisiz iÅŸlem.");
    if (!confirm("Tahmin oyununu kapatmak istediÄŸinizden emin misiniz?")) return;

    db.collection("predictionGame").doc("activeGame").update({ isActive: false, results: null })
        .then(() => {
            alert("Tahmin oyunu kapatÄ±ldÄ±.");
        }).catch(error => { console.error("Oyun kapatma hatasÄ±: ", error); alert("Oyun kapatÄ±lÄ±rken hata oluÅŸtu. Firebase kurallarÄ±nÄ±zÄ± kontrol edin."); });
}

function submitPrediction() {
    const name = document.getElementById("tahminName").value.trim();
    const scoreA = document.getElementById("tahminScoreA").value;
    const scoreB = document.getElementById("tahminScoreB").value;
    const matchResult = document.querySelector('input[name="tahminMatchResult"]:checked');
    const goalCount = document.querySelector('input[name="tahminGoalCount"]:checked');
    const cardCount = document.querySelector('input[name="tahminCardCount"]:checked');
    const gameId = currentPredictionGame.id;

    if (!name || !scoreA || !scoreB || !matchResult || !goalCount || !cardCount) {
        return alert("AdÄ±nÄ±z ve tÃ¼m tahmin alanlarÄ± zorunludur!");
    }
    
    if (parseInt(scoreA) < 0 || parseInt(scoreB) < 0) {
        return alert("Skorlar negatif olamaz!");
    }

    const predictionData = {
        name: name,
        scoreA: parseInt(scoreA),
        scoreB: parseInt(scoreB),
        matchResult: matchResult.value,
        goalCount: goalCount.value,
        cardCount: cardCount.value,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    db.collection("predictionGame").doc(gameId).collection("predictions").doc(name) 
        .set(predictionData)
        .then(() => {
            alert("Tahmininiz kaydedildi! Ä°yi ÅŸanslar.");
            document.getElementById("predictionGameContainer").innerHTML = `
                <div class="predictionForm">
                    <p class="tahminBaslik">âœ… ${currentPredictionGame.matchName} iÃ§in **tahmininiz kaydedildi**.</p>
                    <p style="text-align: center;">MaÃ§ sonucunu ve kazananlarÄ± bu alandan takip edebilirsiniz.</p>
                </div>
            `;
        })
        .catch(error => {
            alert("Tahmin kaydedilirken hata oluÅŸtu. LÃ¼tfen tekrar deneyin.");
            console.error(error);
        });
}

function showActivePredictionGame() {
    db.collection("predictionGame").doc("activeGame").onSnapshot(doc => {
        const container = document.getElementById("predictionGameContainer");

        if (doc.exists && doc.data().isActive) {
            currentPredictionGame = { ...doc.data(), id: doc.id };
            const data = doc.data();
            const deadlineTime = data.deadline;
            const now = new Date().getTime();
            
            if (data.results && data.results.published) {
                displayPredictionResults(data);
                return;
            }

            if (now > deadlineTime) {
                container.innerHTML = `<div class="predictionForm"><p class="tahminBaslik">â° **${data.matchName} maÃ§Ä± iÃ§in tahmin sÃ¼resi doldu!**</p><p>Admin sonuÃ§larÄ± girdiÄŸi zaman kazananlar aÃ§Ä±klanacaktÄ±r.</p></div>`;
                return;
            }

            container.innerHTML = generatePredictionForm(data);
        } else {
            currentPredictionGame = null;
            container.innerHTML = '<p style="font-style: italic; color: #777;">Åu anda aktif bir tahmin oyunu bulunmamaktadÄ±r. Admin tarafÄ±ndan baÅŸlatÄ±lmasÄ± bekleniyor.</p>';
        }
    });
}

function generatePredictionForm(data) {
    const deadlineStr = new Date(data.deadline).toLocaleString('tr-TR');
    
    const teamA = data.teamA;
    const teamB = data.teamB;

    return `
        <div class="predictionForm">
            <p class="tahminBaslik">${data.matchName} Tahmin Et</p>
            <p style="font-size: 12px; color: #dc3545; text-align: center;">â° Son Tahmin: **${deadlineStr}**</p>
            
            <input type="text" id="tahminName" placeholder="AdÄ±nÄ±z (Zorunlu)" style="max-width: 150px; display: inline-block;">
            
            <h4 style="margin-top: 15px;">1. **MaÃ§ Skoru** (Ã–rn: 2-1)</h4>
            <input type="number" id="tahminScoreA" min="0" max="9" value="0" placeholder="${teamA} Skoru" style="max-width: 100px;">
            -
            <input type="number" id="tahminScoreB" min="0" max="9" value="0" placeholder="${teamB} Skoru" style="max-width: 100px;">

            <h4 style="margin-top: 15px;">2. **MaÃ§ Sonucu** (1-X-2)</h4>
            <div style="text-align: center;">
                <label class="prediction-selection"><input type="radio" name="tahminMatchResult" value="1"> **1** (${teamA})</label>
                <label class="prediction-selection"><input type="radio" name="tahminMatchResult" value="X"> **X** (Berabere)</label>
                <label class="prediction-selection"><input type="radio" name="tahminMatchResult" value="2"> **2** (${teamB})</label>
            </div>

            <h4 style="margin-top: 15px;">3. **Toplam Gol** (2.5)</h4>
            <div style="text-align: center;">
                <label class="prediction-selection"><input type="radio" name="tahminGoalCount" value="ust"> Ãœst</label>
                <label class="prediction-selection"><input type="radio" name="tahminGoalCount" value="alt"> Alt</label>
            </div>

            <h4 style="margin-top: 15px;">4. **SarÄ± Kart** (4.5)</h4>
            <div style="text-align: center;">
                <label class="prediction-selection"><input type="radio" name="tahminCardCount" value="ust"> Ãœst</label>
                <label class="prediction-selection"><input type="radio" name="tahminCardCount" value="alt"> Alt</label>
            </div>

            <button onclick="submitPrediction()" style="margin-top: 20px; background-color: #007bff;">Tahmini GÃ¶nder</button>
        </div>
    `;
}

function displayPredictionResults(gameData) {
    const results = gameData.results;
    const gameId = currentPredictionGame.id;
    const container = document.getElementById("predictionGameContainer");
    
    let resultHTML = `
        <div class="predictionResults">
            <p class="tahminBaslik">ğŸ‰ **${gameData.matchName} MAÃ‡ SONUÃ‡LARI VE KAZANANLAR** ğŸ‰</p>
            <h4 style="color: #28a745;">âš½ MAÃ‡ SKORU: **${results.scoreA} - ${results.scoreB}**</h4>
            <p>SonuÃ§ (1-X-2): **${results.matchResult}** | Gol (2.5): **${results.goalCount}** | Kart (4.5): **${results.cardCount}**</p>
            <hr>
            <h3>ğŸ† KAZANANLAR</h3>
            <div class="kazananlarListesi" id="winnersList">YÃ¼kleniyor...</div>
        </div>
    `;
    container.innerHTML = resultHTML;

    db.collection("predictionGame").doc(gameId).collection("predictions").get()
        .then(snapshot => {
            const winners = [];
            snapshot.forEach(doc => {
                const p = doc.data();
                let points = 0;
                
                if (p.scoreA === results.scoreA && p.scoreB === results.scoreB) { points += 5; } 
                if (p.matchResult === results.matchResult) { points += 2; }
                if (p.goalCount === results.goalCount) { points += 1; }
                if (p.cardCount === results.cardCount) { points += 1; }

                if (points > 0) {
                    winners.push({ name: p.name, points: points, prediction: `${p.scoreA}-${p.scoreB}` });
                }
            });

            winners.sort((a, b) => b.points - a.points);
            
            const listContainer = document.getElementById("winnersList");
            if (winners.length === 0) {
                listContainer.innerHTML = "<p style='text-align: center; color: #dc3545;'>Bu maÃ§ iÃ§in hiÃ§ doÄŸru tahmin yok! Belki bir dahaki sefere.</p>";
            } else {
                let listHtml = "<ol>";
                winners.forEach((w) => {
                    listHtml += `<li>**${w.name}** (${w.points} Puan) | Skor Tahmini: ${w.prediction}</li>`;
                });
                listHtml += "</ol>";
                listContainer.innerHTML = listHtml;
            }
        });
}

// Sayfa yÃ¼klendiÄŸinde quiz ve anket listener'larÄ±nÄ± baÅŸlat
loadActiveQuiz(); 
loadActivePoll(); 

</script>
</body>
</html>

